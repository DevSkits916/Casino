<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>High / Low</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(160deg, #09203f, #071420 65%);
      color: #f4f9ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .panel {
      width: 100%;
      max-width: 620px;
      background: rgba(12, 26, 42, 0.92);
      border-radius: 18px;
      padding: 32px;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.45);
    }
    h1 {
      text-align: center;
      margin: 0 0 8px;
    }
    .info {
      text-align: center;
      color: #9ed0ff;
      margin-bottom: 16px;
    }
    .balance {
      margin-top: 4px;
      font-size: 1.2rem;
    }
    .card {
      font-size: 4rem;
      text-align: center;
      margin: 24px 0 12px;
    }
    .gate {
      text-align: center;
      margin-bottom: 20px;
    }
    .gate input {
      max-width: 220px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #f4f9ff;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    button {
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #4cc9f0, #4361ee);
      color: #04152a;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(67, 97, 238, 0.35);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .controls {
      display: grid;
      gap: 16px;
    }
    .controls input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #f4f9ff;
      font-size: 1rem;
      width: 100%;
    }
    .guess-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .result {
      min-height: 1.5em;
      text-align: center;
      margin-top: 14px;
      color: #8be9fd;
    }
    .result.error {
      color: #ff6b6b;
    }
    .footer-actions {
      margin-top: 28px;
      display: flex;
      justify-content: center;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>High / Low</h1>
    <div class="gate" id="gate">
      <p>Enter your username to start playing.</p>
      <input type="text" id="gateUsername" placeholder="Username" autocomplete="off" />
      <button id="gateLoadBtn">Load Profile</button>
      <div class="result" id="gateStatus"></div>
    </div>
    <div id="game" class="hidden">
      <div class="info">
        <div id="playerLabel">Player: --</div>
        <div class="balance" id="balanceLabel">Balance: -- credits</div>
      </div>
      <div class="card" id="currentCard">?</div>
      <div class="controls">
        <div>
          <label for="wagerInput">Wager</label>
          <input type="number" id="wagerInput" min="1" value="50" />
        </div>
        <div class="guess-buttons">
          <button id="higherBtn" data-guess="higher" disabled>Higher</button>
          <button id="lowerBtn" data-guess="lower" disabled>Lower</button>
        </div>
      </div>
      <div class="result" id="resultMessage"></div>
      <div class="footer-actions">
        <button id="backBtn">Save &amp; Back to Lobby</button>
      </div>
    </div>
  </div>
  <script>
    const gate = document.getElementById('gate');
    const gameSection = document.getElementById('game');
    const gateInput = document.getElementById('gateUsername');
    const gateLoadBtn = document.getElementById('gateLoadBtn');
    const gateStatus = document.getElementById('gateStatus');
    const playerLabel = document.getElementById('playerLabel');
    const balanceLabel = document.getElementById('balanceLabel');
    const currentCardEl = document.getElementById('currentCard');
    const wagerInput = document.getElementById('wagerInput');
    const higherBtn = document.getElementById('higherBtn');
    const lowerBtn = document.getElementById('lowerBtn');
    const resultMessage = document.getElementById('resultMessage');
    const backBtn = document.getElementById('backBtn');

    const state = {
      username: null,
      balance: 0,
      card: null,
      busy: false,
    };

    function setGateStatus(message, isError = false) {
      gateStatus.textContent = message || '';
      gateStatus.classList.toggle('error', isError);
    }

    function setResult(message, isError = false) {
      resultMessage.textContent = message || '';
      resultMessage.classList.toggle('error', isError);
    }

    function cardName(value) {
      const names = {
        1: 'Ace',
        11: 'Jack',
        12: 'Queen',
        13: 'King',
      };
      return names[value] || value;
    }

    function drawCard() {
      return Math.floor(Math.random() * 13) + 1;
    }

    function updateCardDisplay() {
      currentCardEl.textContent = cardName(state.card);
    }

    function updateBalance() {
      balanceLabel.textContent = `Balance: ${state.balance} credits`;
    }

    async function loadProfile(username) {
      const trimmed = (username || '').trim();
      if (!trimmed) {
        setGateStatus('Please enter a username.', true);
        return;
      }
      setGateStatus('Loading...');
      try {
        const resp = await fetch(`/api/profile?username=${encodeURIComponent(trimmed)}`);
        const data = await resp.json();
        if (!data.ok) {
          throw new Error(data.error || 'Failed to load profile');
        }
        state.username = data.username;
        state.balance = data.balance;
        playerLabel.textContent = `Player: ${state.username}`;
        updateBalance();
        state.card = drawCard();
        updateCardDisplay();
        gate.classList.add('hidden');
        gameSection.classList.remove('hidden');
        setResult('Make your guess!');
        higherBtn.disabled = false;
        lowerBtn.disabled = false;
      } catch (err) {
        console.error(err);
        setGateStatus('Unable to load profile.', true);
      }
    }

    async function charge(amount, desc) {
      const resp = await fetch('/api/game/charge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: state.username, game: 'highlow', amount, desc })
      });
      return resp.json();
    }

    async function payout(amount, desc) {
      const resp = await fetch('/api/game/payout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: state.username, game: 'highlow', amount, desc })
      });
      return resp.json();
    }

    async function handleGuess(direction) {
      if (state.busy) return;
      const wager = Math.max(0, Math.floor(parseInt(wagerInput.value, 10)) || 0);
      if (wager <= 0) {
        setResult('Enter a valid wager.', true);
        return;
      }
      if (wager > state.balance) {
        setResult('Not enough credits for that wager.', true);
        return;
      }
      state.busy = true;
      higherBtn.disabled = true;
      lowerBtn.disabled = true;
      setResult('Drawing the next card...');
      try {
        const chargeResp = await charge(wager, 'highlow wager');
        if (!chargeResp.ok) {
          if (chargeResp.error === 'INSUFFICIENT_FUNDS') {
            state.balance = chargeResp.balance;
            updateBalance();
            setResult('Insufficient funds.', true);
          } else {
            setResult('Charge failed.', true);
          }
          return;
        }
        state.balance = chargeResp.balance;
        updateBalance();

        const nextCard = drawCard();
        const comparison = nextCard === state.card ? 0 : nextCard > state.card ? 1 : -1;
        let winnings = 0;
        if ((comparison > 0 && direction === 'higher') || (comparison < 0 && direction === 'lower')) {
          winnings = wager * 2;
          setResult(`Correct! ${cardName(nextCard)} beats ${cardName(state.card)}.`);
        } else if (comparison === 0) {
          winnings = wager;
          setResult(`Tie! Both cards are ${cardName(nextCard)}. Wager returned.`);
        } else {
          setResult(`Wrong! ${cardName(nextCard)} does not match your guess.`);
        }
        state.card = nextCard;
        updateCardDisplay();

        if (winnings > 0) {
          const payoutResp = await payout(winnings, winnings === wager * 2 ? 'highlow win' : 'highlow tie refund');
          if (payoutResp.ok) {
            state.balance = payoutResp.balance;
            updateBalance();
          } else {
            setResult('Payout failed.', true);
          }
        }
      } catch (err) {
        console.error(err);
        setResult('An error occurred.', true);
      } finally {
        state.busy = false;
        higherBtn.disabled = false;
        lowerBtn.disabled = false;
      }
    }

    gateLoadBtn.addEventListener('click', () => loadProfile(gateInput.value));
    higherBtn.addEventListener('click', () => handleGuess('higher'));
    lowerBtn.addEventListener('click', () => handleGuess('lower'));

    backBtn.addEventListener('click', async () => {
      if (!state.username) return;
      backBtn.disabled = true;
      try {
        await fetch('/api/profile/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: state.username, balance: state.balance })
        });
      } catch (err) {
        console.error(err);
      } finally {
        window.location.href = `lobby.html?u=${encodeURIComponent(state.username)}`;
      }
    });

    const params = new URLSearchParams(window.location.search);
    const presetUser = params.get('u');
    if (presetUser) {
      gateInput.value = presetUser;
      loadProfile(presetUser);
    }
  </script>
</body>
</html>
