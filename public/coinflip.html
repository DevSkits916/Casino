<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coin Flip</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(140deg, #0b1220, #1a2e47);
      color: #f2f7ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .panel {
      width: 100%;
      max-width: 520px;
      background: rgba(11, 22, 36, 0.92);
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
    }
    h1 {
      text-align: center;
      margin: 0 0 10px;
    }
    .info {
      text-align: center;
      color: #9ed0ff;
      margin-bottom: 18px;
    }
    .balance {
      margin-top: 6px;
      font-size: 1.2rem;
    }
    .coin {
      font-size: 5rem;
      text-align: center;
      margin: 24px 0;
    }
    .gate {
      text-align: center;
      margin-bottom: 20px;
    }
    .gate input {
      width: 100%;
      max-width: 220px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #f2f7ff;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    button {
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #fcbf49, #f77f00);
      color: #2b1600;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(247, 127, 0, 0.35);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .controls {
      display: grid;
      gap: 16px;
    }
    .controls input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #f2f7ff;
      font-size: 1rem;
      width: 100%;
    }
    .choice-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .result {
      min-height: 1.5em;
      text-align: center;
      margin-top: 18px;
      color: #90e0ef;
    }
    .result.error {
      color: #ff6b6b;
    }
    .footer-actions {
      margin-top: 26px;
      display: flex;
      justify-content: center;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Coin Flip</h1>
    <div class="gate" id="gate">
      <p>Enter your username to play.</p>
      <input type="text" id="gateUsername" placeholder="Username" autocomplete="off" />
      <button id="gateLoadBtn">Load Profile</button>
      <div class="result" id="gateStatus"></div>
    </div>
    <div id="game" class="hidden">
      <div class="info">
        <div id="playerLabel">Player: --</div>
        <div class="balance" id="balanceLabel">Balance: -- credits</div>
      </div>
      <div class="coin" id="coinFace">ðŸª™</div>
      <div class="controls">
        <div>
          <label for="wagerInput">Wager</label>
          <input type="number" id="wagerInput" min="1" value="50" />
        </div>
        <div class="choice-buttons">
          <button data-choice="HEADS" id="headsBtn" disabled>Heads</button>
          <button data-choice="TAILS" id="tailsBtn" disabled>Tails</button>
        </div>
      </div>
      <div class="result" id="resultMessage"></div>
      <div class="footer-actions">
        <button id="backBtn">Save &amp; Back to Lobby</button>
      </div>
    </div>
  </div>
  <script>
    const gate = document.getElementById('gate');
    const gameSection = document.getElementById('game');
    const gateInput = document.getElementById('gateUsername');
    const gateLoadBtn = document.getElementById('gateLoadBtn');
    const gateStatus = document.getElementById('gateStatus');
    const playerLabel = document.getElementById('playerLabel');
    const balanceLabel = document.getElementById('balanceLabel');
    const coinFace = document.getElementById('coinFace');
    const wagerInput = document.getElementById('wagerInput');
    const headsBtn = document.getElementById('headsBtn');
    const tailsBtn = document.getElementById('tailsBtn');
    const resultMessage = document.getElementById('resultMessage');
    const backBtn = document.getElementById('backBtn');

    const state = {
      username: null,
      balance: 0,
      busy: false,
    };

    function setGateStatus(message, isError = false) {
      gateStatus.textContent = message || '';
      gateStatus.classList.toggle('error', isError);
    }

    function setResult(message, isError = false) {
      resultMessage.textContent = message || '';
      resultMessage.classList.toggle('error', isError);
    }

    function updateBalance() {
      balanceLabel.textContent = `Balance: ${state.balance} credits`;
    }

    async function loadProfile(username) {
      const trimmed = (username || '').trim();
      if (!trimmed) {
        setGateStatus('Please enter a username.', true);
        return;
      }
      setGateStatus('Loading...');
      try {
        const resp = await fetch(`/api/profile?username=${encodeURIComponent(trimmed)}`);
        const data = await resp.json();
        if (!data.ok) {
          throw new Error(data.error || 'Failed to load profile');
        }
        state.username = data.username;
        state.balance = data.balance;
        playerLabel.textContent = `Player: ${state.username}`;
        updateBalance();
        gate.classList.add('hidden');
        gameSection.classList.remove('hidden');
        headsBtn.disabled = false;
        tailsBtn.disabled = false;
        setResult('Pick a side!');
      } catch (err) {
        console.error(err);
        setGateStatus('Unable to load profile.', true);
      }
    }

    async function charge(amount, desc) {
      const resp = await fetch('/api/game/charge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: state.username, game: 'coinflip', amount, desc })
      });
      return resp.json();
    }

    async function payout(amount, desc) {
      const resp = await fetch('/api/game/payout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: state.username, game: 'coinflip', amount, desc })
      });
      return resp.json();
    }

    async function handleChoice(choice) {
      if (state.busy) return;
      const wager = Math.max(0, Math.floor(parseInt(wagerInput.value, 10)) || 0);
      if (wager <= 0) {
        setResult('Enter a valid wager.', true);
        return;
      }
      if (wager > state.balance) {
        setResult('Not enough credits for that wager.', true);
        return;
      }
      state.busy = true;
      headsBtn.disabled = true;
      tailsBtn.disabled = true;
      setResult('Flipping...');
      try {
        const chargeResp = await charge(wager, `coinflip wager (${choice})`);
        if (!chargeResp.ok) {
          if (chargeResp.error === 'INSUFFICIENT_FUNDS') {
            state.balance = chargeResp.balance;
            updateBalance();
            setResult('Insufficient funds.', true);
          } else {
            setResult('Charge failed.', true);
          }
          return;
        }
        state.balance = chargeResp.balance;
        updateBalance();

        const outcome = Math.random() < 0.5 ? 'HEADS' : 'TAILS';
        coinFace.textContent = outcome === 'HEADS' ? 'ðŸ˜€' : 'ðŸ˜Ž';
        if (outcome === choice) {
          const winnings = wager * 2;
          setResult(`You won! It was ${outcome}.`);
          const payoutResp = await payout(winnings, 'coinflip win');
          if (payoutResp.ok) {
            state.balance = payoutResp.balance;
            updateBalance();
          } else {
            setResult('Payout failed.', true);
          }
        } else {
          setResult(`You lost. It was ${outcome}.`);
        }
      } catch (err) {
        console.error(err);
        setResult('An error occurred.', true);
      } finally {
        state.busy = false;
        headsBtn.disabled = false;
        tailsBtn.disabled = false;
      }
    }

    gateLoadBtn.addEventListener('click', () => loadProfile(gateInput.value));
    headsBtn.addEventListener('click', () => handleChoice('HEADS'));
    tailsBtn.addEventListener('click', () => handleChoice('TAILS'));

    backBtn.addEventListener('click', async () => {
      if (!state.username) return;
      backBtn.disabled = true;
      try {
        await fetch('/api/profile/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: state.username, balance: state.balance })
        });
      } catch (err) {
        console.error(err);
      } finally {
        window.location.href = `lobby.html?u=${encodeURIComponent(state.username)}`;
      }
    });

    const params = new URLSearchParams(window.location.search);
    const presetUser = params.get('u');
    if (presetUser) {
      gateInput.value = presetUser;
      loadProfile(presetUser);
    }
  </script>
</body>
</html>
